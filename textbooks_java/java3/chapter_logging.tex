\chapter{Logging}


\section{Logging Framework}

A logging framework is a utility specifically designed to standardize the process of logging in your application.  Logging is very important for debugging and identifying performance hot spots in an application, as well as getting a sense of how your application operates.  The following recommendations about logging can be find in OWASP Logging Guide \footnote{\url{https://owasp.org/www-pdf-archive/OWASP_Logging_Guide.pdf}}:

\begin{itemize}
\item Why log?
\begin{itemize}
\item identify security incidents
\item identify fraudulent activity
\item identify operational and longterm problems
\item ensure compliance with laws,rules and regulations
\end{itemize}
\item What is commonly logged ?
\begin{itemize}
\item Client requests and server responses
\item Account activities (login, logout, change password etc.)
\item Usage information (transaction types and sizes, generated traffic etc.)
\item Significant operational actions such as application startup and shutdown, application failures, and major application configuration changes. This can be used to identify security compromises and operational failures.
\end{itemize}
\end{itemize}

Much of this info can only be logged by the applications themselves. This is especially true for applications used through encrypted network communications. Therefore we need a standardized process of logging where log-files can be archived easily.

\section{Log levels}

\begin{tabular}{|c|p{12cm}|}
\hline
Level & Description \\
\hline
FATAL & the log level that tells that the application encountered an event or entered a state in which one of the crucial business functionality is no longer working. \\

ERROR &  the log level that should be used when the application hits an issue preventing one or more functionalities from properly functioning.\\

WARN & the WARN level should be used in situations that are unexpected, but the code can continue the work. \\

INFO & information logged using the INFO log level should be purely informative and not looking into them on a regular basis shouldnâ€™t result in missing any important information\\

DEBUG & should be used for information that may be needed for diagnosing issues and troubleshooting or when running application in the test environment for the purpose of making sure everything is running correctly \\

TRACE &  the most fine-grained information only used in rare cases where you need the full visibility of what is happening in your application \\
\hline
\end{tabular}

\section{Logging in Spring Boot \footnote{\url{https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging}}}

Spring Boot uses Apache Commons logging for all internal logging. Commons logging is a bridge to a the logging implementation of your choice. You can choose the logging system you like: log4j2, SLF4J, LogBack, etc.

By default, if you use the `Starters', Logback is used for logging. It is pre-configured to use console output.


Add the following controller to an existing Spring Boot application and trigger the logging lines by visiting \url{http://localhost:{port}/loglevels}.


\begin{lstlisting}
package be.pxl.demo.api;

@RestController
public class LoggingController {

    Logger logger = LoggerFactory.getLogger(LoggingController.class);

    @RequestMapping("/loglevels")
    public String demoLogLevels() {
        logger.trace("A TRACE Message");
        logger.debug("A DEBUG Message");
        logger.info("An INFO Message");
        logger.warn("A WARN Message");
        logger.error("An ERROR Message");

        return "Howdy! Check out the Logs to see the output...";
    }
}
\end{lstlisting}

The default logging level of the Logger is preset to INFO, meaning that TRACE and DEBUG messages are not visible.

In the file application.properties you can change the log level by using logging.level.<logger-name>=<level>.

\section{Log4j2 Configuration Logging}

However, we will separate specifications for console and file output. We would like a decent rolling policy to avoid huge log files.

In this course we will use log4j2.  End 2021 a critical vulnerability was found in log4j which affected millions of systems \footnote{\url{https://cisomag.eccouncil.org/log4j-explained}}.  Make sure you use the latest version in your applications.

Apache's website on Log4j 2 shows which dependencies to add in your pom.xml to start using Log4j 2.   The website's URL is \url{https://logging.apache.org/log4j/2.x/maven-artifacts.html}. 

To start using log4j2 in you Spring boot application, you must update the dependencies in pom.xml.

Exclude the default logging and add the starter for log4j2.\\

\begin{lstlisting}
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>
\end{lstlisting}


\begin{} 

Here is an example of a configuration file:

\begin{lstlisting}[language=xml, frame=single]
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
	<Appenders>
		<File name="LogToFile" fileName="logs/superhero.log">
			<PatternLayout>
				<Pattern>%d %p %c{1.} [%t] %m%n</Pattern>
			</PatternLayout>
		</File>
		<Console name="LogToConsole" target="SYSTEM_OUT">
			<PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
		</Console>
	</Appenders>
	<Loggers>
		<Logger name="be.pxl.paj.domain" level="debug" additivity="false">
			<AppenderRef ref="LogToFile"/>
		</Logger>
		<Root level="all">
			<AppenderRef ref="LogToConsole"/>
		</Root>
	</Loggers>
</Configuration>
\end{lstlisting}

The logging level used in the tag \xml{Configuration} is for Log4j 2 internal events.
We created 2 Appenders, one Appender uses the console, the other Appender uses a file. 
The description of the logging patterns can be found in the Javadoc of the class PatternLayout (\url{https://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html}).
The logging for all classes in the package be.pxl.paj.domain is added to the file. All other logging can be found in the console.

\begin{lstlisting}[language=java, frame=single]
package be.pxl.paj.domain;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class Superhero {

	private static final Logger LOGGER = LogManager.getLogger(Superhero.class);
	private String firstName;
	private String lastName;
	private String superheroName;

	public Superhero(String firstName, String lastName, String superheroName) {
		LOGGER.debug("Creating a new superhero...");
		this.firstName = firstName;
		this.lastName = lastName;
		this.superheroName = superheroName;
	}

	public String getFirstName() {
		LOGGER.trace("FirstName of " + superheroName + " was revealed.");
		return firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getLastName() {
		LOGGER.fatal("LastName of " + superheroName + " was revealed.");
		return lastName;
	}

	public void setLastName(String lastName) {
		this.lastName = lastName;
	}

	public String getSuperheroName() {
		return superheroName;
	}

	public void setSuperheroName(String superheroName) {
		this.superheroName = superheroName;
	}
}
\end{lstlisting}

 \begin{lstlisting}[language=java,frame=single]
package be.pxl.paj;

import be.pxl.paj.domain.Superhero;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class App {

	private static final Logger LOGGER = LogManager.getLogger(App.class);

	public static void main(String[] args) {
		if (LOGGER.isDebugEnabled()) {
			LOGGER.debug("Starting app on " + System.getProperty("os.name") + "...");
		}
		Superhero superhero = new Superhero("Clark", "Kent", "Superman");
		LOGGER.info(superhero.getFirstName());
		LOGGER.info(superhero.getLastName());
		LOGGER.warn("Stopping app....");
	}
}
\end{lstlisting}

Always declare a static Logger reference, the creation of a Logger comes with an overhead. 
It is good practice to use isDebugEnabled() when creating debug log because it will save potential String concatenation activity.

\begin{oefening}
\begin{todolist}
\item Add Log4j 2 to your maven project SampleLoggingProject.
\item Add the Log4j 2 configuration file from the textbook to your application. 
\item Create the class Superhero in the package be.pxl.paj.domain.
\item Implement the main-class as defined above.
\item Run the application and examin all logging. Change log levels in the configuration file and run the application again.  What happens with the data in the superhero.log file when you rerun the application?
\end{todolist}
\end{oefening}